~~해야할 것.
리프레시 토큰 추가
->엑세스토큰은 정상작동함. 다만 리프레시 토큰이 관여하는 부분이 아예 없는 상태
단순히 리프레시 토큰은 발급만 되고 사용이 아예 안되는 상태.
리프레시 토큰이 유효한지 검증하고(db에 저장하는것도 해야함), 리프레시 토큰을 이용해 엑세스토큰 재발급과 재발급 시 리프레시도 재발급되도록 해야함.
-> 리프레시 토큰 db저장은 가능. 리프레시토큰을 이용해 재발급받는 api도 만들었음.
->이제 프론트에서 요청이 들어왔을 때, 엑세스토큰 만료일경우 리프레시 토큰을 보내라고 리턴
그 이후 리프레시 토큰을 헤더에 넣어서 /token/refresh로 요청이 되도록 하기
이 과정이 쉽지않음...
지금 post나 get요청을 보낼 때, function에 묶여있지 않고 이벤트리스너로만 처리되어있음.
이벤트리스너 내부 기능을 function으로 꺼내서 처리
<-끝. 실패하면 자동으로 토큰 재발행 후 다시 시도됨.
jwt를 로컬스토리지 저장에서 쿠키저장으로 다 바꿔야함
사유 : 서버 사이드 렌더링에 로그인여부반영을 못함.
->js상에서는 쿠키에 저장하도록 다 수정해둔 상태.
//8월 22일 여기서부터 시작
다만 컨트롤러랑 jwt필터에서 헤더가 아닌 쿠키에서 토큰을 꺼내오도록 수정해줘야함.
또한 js에서 fetch로 요청할 때, 쿠키에 토큰을 꺼내서 헤더에 넣어서 보내는데, 이 과정을 다 지워줘야함.
jwtfilter에서 쿠키를 못읽는중임.
https://www.inflearn.com/community/questions/592226/%EC%BF%A0%ED%82%A4%EA%B0%80-%EC%A0%84%EC%86%A1%EC%9D%80-%EB%90%98%EB%8A%94%EB%8D%B0-%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80-%EB%82%B4%EB%B6%80%EC%97%90-%EC%A0%80%EC%9E%A5%EB%90%98%EC%A7%80-%EC%95%8A%EC%8A%B5%EB%8B%88%EB%8B%A4~~
~~1. 쿠키는 공백문자를 허용하지 않는다.~~
~~2. 토큰 검증 시 Bearer 로 시작하지 않으면 올바른 jwt라 아니라면서 익셉션이 발생한다.~~
~~3. 쿠키에는 Bearer 를 제외한 토큰만 던지고, 스프링으로 넘어오면 Bearer 를 붙여줘야함~~
~~//////////////////////////////////////////////
fetch로 요청을 보낼때는 credentials:'include'를 method와 함께 넣어줘야함.
정확히는 fetch함수의 2번째 매개변수자리에 json형식으로 들어감
service에서 쿠키를 쓸 일이 있으면 getCookie_Bearer를 활용해야함.
현재 백엔드에서 쿠키에 있는 토큰 잘 받고, 잘 보내는 중임.
///////////////////////////////~~

~~[해결]사실 로그아웃은 restapi가 아니라 그냥 homecontroller에 추가해야할지도?....~~
~~[해결]로그아웃 시 리다이렉트 넣어줘야함.~~
~~[이거먼저해야함]로그인 시 이상하게 alert가 뜨는 것,~~
~~엑세스토큰 만료되면 그거물고 메세지만 리턴하고 리프레시가 안됨.(JwtFilter)~~
~~1. /api/v1/users/edit에 관한건 다 만들었음. 프론트에서 post요청 보내고 리턴되면 새로고침을 하던 알림을 띄우던 해줘야함.
->post보내면 타입이 안맞는지 객체에 안들어감(mypage.js)~~
~~회원탈퇴 페이지 제작, api제작 회원탈퇴 시 경고문출력, 닉네임 타이핑, 바 맨 오른쪽으로 끌기~~
~~회원탈퇴 시도 시, refresh_token에 토큰이 삭제 안되고 있음.
이유 : delete할때 토큰값에 bearer가 붙어있는상태.
db에는 bearer가 없어서 비교가 안됨
JwtTokenService에 deleteRefreshToken usage를 확인~~
~~현재 entity에 관련된 문제인지, 로그인, 리프레시등 리프레시토큰 테이블에 관련된 작업은 싹 다 불가능한 상태.
예상되는 원인은 user_id, token, expireation_date, created_at을 insert나 select할 때, user_id에 해당하는 문자열을 refresh_token에 넣는게 아니라, Long타입, 즉 user에 있는 pk키인 id를 refresh_token.user_id에 넣으려고 해서 생기는 문제로 보임.
그에 대한 근거로 엔티티에서 user와 refreshtoken의 관계를 주석처리하면 인식을 못하는 상태~~
~~판매자 센터에서 받아와야 할 정보
카테고리 테이블 정보 불러와서 map에 넣음. 다만 id가 100미만인 애들만
부모카테고리 분류를 위해 id가 100이상인 애들만 넣음
타임리프에서 처음 부모카테고리를 그림.
그 아래에 바로 foreach로 부모카테고리와 id같은애들을 그림
그 아래에 grid로 묶고 스위치와 summary입력폼을 그려줌
스위치와 입력폼은 null인지 아닌지에 따라 value, 또한 입력폼은 null이면 아예 disabled
seller_item쪽 content_id는 필요없음, user_id같은 컬럼 다 불러와서 map에 넣기(그냥 싹 다 select)
백엔드는 다 한듯.
이제 프론트에서 해줘야함
참고사항메모에 있는 것 참조해서 db설계.
추후 추가해야 할 컬럼~~
~~지금 결국 refresh_token.user_id에 user.id가 들어가려고하니 문제가 생기는 것
그냥 user_id가 user.userid대신 user.id를 참조하게 하는게 방법이 아닐까 싶음.
이렇게 하면 User객체에서 userid를 바로 꺼내올 수 있으니 괜찮지 않을까? 싶은 상태
->일단 해결은 된 것 같음. 다른 부분 하면서 문제생기면 그 부분만 수정하면 될 듯
이중으로 반복문을 돌리는게 쉽지않음.
차라리 판매자등록이 되는 순간 seller_item에 카테고리만큼의 데이터를 와다다 집어넣고, 셀러아이템에 체크유무는 boolean으로 처리하는것도 방법이지 않을까 싶음.
타임리프에서 그릴때는, 어차피 카테고리번호-1 인덱스로 접근하면 해당 데이터가 될거임
체크를 풀면 초기값으로 돌려버리고~~
~~(방금 생각남) -> 게임류 오락류 판매자에서 리스트를 길게 뽑지말고 아코디언에 담궈두는것도 괜찮을듯.~~
~~homecontroller 모델넣는것까지만 함.
api를 먼저 만들어야함.
user에 이어서, 다른 사람의 user객체, 또한 다른 사람의 seller_item객체까지 가져와야한다.
자신이 타인의 프로필정보를 보는 페이지
이건 status가 1인것만 출력하고, 닉네임과 성별정도만 노출되도록 해야함~~

~~또한 팔로우같은게 생겨야함.
팔로우 테이블이 필요하다.
pk, 한 사람, 대상 이렇게 구성되어있으면 될 듯?~~
~~언팔로우가 작동안함, 500에러 커스텀예외뜨는중~~
~~팔로우 중인지 아닌지 알 수 있는걸 하나 넣어야함.
단순히 count로 계산해도 되고 Follow객체로 받아서 orelsenull한다음 뭐가됐든간에 other_info.th.html에 넣어줘야함.~~
~~팔로우, 팔로워 수를 계산하고, 목록을 띄워주는걸 만들어야함.~~
~~계산하고 그러는 로직자체는 구현되어있는 상태.
목록은 그냥 페이지를 하나 더 만들어야함.~~
~~어차피 문구만 조금 다르고, 목록뽑아주는건 똑같으니 하나의 페이지를 재활용하면 됨.~~

~~팔로우팔로워 확인페이지는 완성됨.
하지만 팔로우목록으로 들어가게되면, 본인 닉네임이 나오게 됨.
내일 고칠거임 즐 ㅗㅗ
->사유 : 돌려막기로 한다고 했는데, follow테이블에 follower와 followed가 있음.
타임리프에서 ??.follower.userid로 접근하기때문에 그런거임~~
## 해야할 것

[먼저해야함]
~~그라바타는 이메일주소를 sha256Hex에 넣은 값을 https://gravatar.com/avatar/ 여기 뒤에 붙여서 불러오게 됨.
이메일주소는 lowercase로 바꿔줘야함.
이메일주소가 수정되거나 생성되는건 가입과 회원정보 수정 뿐.
프로필사진 주소자체를 db에 넣어주면 될듯
쿼리 파라미터 s=200, r=pg, d=retro~~

넣어주는건 끝남.
이제 헤더포함 다른 페이지에서 img를 싹 다 수정해야함.


[하던 것] : 





또한 결국 이 시스템은 이 사람에게 언제 주문을 넣거나 하는 시스템이 추가될 예정임.
그러므로 팔로우 언저리에 예약하기 버튼같은걸 만들어야함.

예약의 플로우는 단순히 예약신청 및 결제->받아주면 예약확정, 안받아주면 그대로 환불.
당일예약 환불불가가 0순위 원칙, 하루 전 수수료 50%, 7일전 수수료 10%, 결제 후 2시간동안 수수료X





[해야할 것]
1. 판매자설정에 시간당 가격설정을 빼먹었음. 추가해야함.
2. 마이페이지 간단하게 제작(~~정보수정~~, ~~회원탈퇴~~, (추후)판매내역, 구매내역 조회 등)
3. 상품목록 띄우기 제일 중요한건 이건 커뮤니티같은 게시판이 아님. 오픈마켓같은 느낌. 글 작성보다 상품등록 느낌으로 만들어야함
4. 2번에 맞는 테이블과 엔티티, 리포지토리 생성
5. 프로필사진 만들어야함. 대신 사진을 어디에 저장할지가 고민임. 로컬에 저장하고 db에 주소를 저장할지, s3를 이용해볼지.
6. 상품목록의 경우 판매자닉네임+프로필사진+시간당 가격+게임+티어+게임모드+성별+나이등이 출력되어야함


마이페이지에서 소셜미디어 링크와 프로필사진변경 추가<-고민중

[문제 고민]



JPA 리스트에 있는 것 한번에 처리 : https://www.inflearn.com/community/questions/1028988/%EB%A6%AC%EC%8A%A4%ED%8A%B8%EB%A5%BC-%ED%95%9C%EB%B2%88%EC%97%90-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8-%ED%95%98%EA%B3%A0%EC%9E%90-%ED%95%A0-%EB%95%8C-%EC%95%84%EB%9E%98%EC%99%80-%EA%B0%99%EC%9D%80-%EB%B0%A9%EB%B2%95-%EB%A7%90%EA%B3%A0-%EB%8B%A4%EB%A5%B8-%EA%B2%8C-%EC%9E%88%EC%9D%84%EA%B9%8C%EC%9A%94
JPA리포지토리 문법 : https://jobc.tistory.com/120